{% extends "base.html" %}
{% block title %}–°–º–µ–Ω—ã –º–∞–≥–∞–∑–∏–Ω–∞{% endblock %}
{% block content %}
<h2 class="text-2xl font-semibold mb-4">üõçÔ∏è –°–º–µ–Ω—ã –∑–∞ {{ month }}/{{ year }} {{ store_name }}</h2>

<a href="/stores/{{ store_id }}/records/create" class="bg-blue-600 text-white px-4 py-2 rounded mb-4 inline-block">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–º–µ–Ω—É</a>
{% if user.role in ['manager', 'admin'] %}
<a href="/stores/{{ store_id }}/vacations/create" class="bg-green-600 text-white px-4 py-2 rounded mb-4 inline-block">üèñ –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—É—Å–∫</a>
{% endif %}
<form method="get" class="mb-6 flex gap-4 items-end">
  <div>
    <label class="block text-sm">–ú–µ—Å—è—Ü</label>
    <input type="number" name="month" value="{{ month }}" min="1" max="12" class="border p-2 rounded w-24">
  </div>
  <div>
    <label class="block text-sm">–ì–æ–¥</label>
    <input type="number" name="year" value="{{ year }}" class="border p-2 rounded w-32">
  </div>
  <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">–ü–æ–∫–∞–∑–∞—Ç—å</button>
</form>

{% for title, data, period in [
  ("1‚Äì15", first_half, first_half_range),
  ("16‚Äì–∫–æ–Ω–µ—Ü", second_half, second_half_range)
] %}
  <h3 class="text-xl font-semibold mt-8 mb-2">üóì –ü–µ—Ä–∏–æ–¥: {{ period[0] }} ‚Äî {{ period[1] }} ({{ title }})</h3>

  <table class="w-full text-sm border">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 border text-left">–î–∞—Ç–∞</th>
        {% if user.role in ['manager', 'admin'] %}
        <th class="p-2 border text-right">–ò—Ç–æ–≥–æ–≤–∞—è –∫–∞—Å—Å–∞ (1C)</th>
        <th class="p-2 border text-right">–ò—Ç–æ–≥–æ–≤–∞—è –∫–∞—Å—Å–∞</th>
        <th class="p-2 border text-right">–¢–µ—Ä–º–∏–Ω–∞–ª</th>
        <th class="p-2 border text-right">–ù–∞–ª–∏—á–Ω—ã–µ –ø–æ –∫–∞—Å—Å–µ</th>
        <th class="p-2 border text-right">–ù–∞–ª–∏—á–Ω—ã–µ –≤ –∫–∞—Å—Å–µ (–∫–æ–Ω–µ—Ü)</th>
        <th class="p-2 border text-right">–†–∞—Å—Ö–æ–¥—ã</th>
        {% endif %}
        <th class="p-2 border text-left">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</th>
        {% if user.role in ['manager', 'admin'] %}
        <th class="p-2 border text-center">–ü—Ä–∞–≤–∫–∞</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for rec in data.days %}
      <tr>
        <td class="p-2 border whitespace-nowrap">{{ rec.date }}</td>
        {% if user.role in ['manager', 'admin'] %}
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.cash) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.cash_total) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.terminal) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.cash_processed) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.cash_on_hand) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.expense_total) }}</td>
        {% endif %}
        <td class="p-2 border">
          <ul class="list-disc list-inside">
          {% for e in rec.employees %}
            <li>
              <span class="font-medium">{{ user_map.get(e.id, "‚Äî") | e }}{% if e.is_warehouse %} (—Å–∫–ª–∞–¥){% endif %}</span>
              <span class="text-gray-500 text-xs">({{ e.start }}‚Äì{{ e.end }})</span>
              {% if user.role != 'cashier' and e.salary %}<span class="ml-1">{{ "%.0f"|format(e.salary) }}</span>{% endif %}
            </li>
          {% endfor %}
          </ul>
        </td>
        {% if user.role in ['manager', 'admin'] %}
        <td class="p-2 border">
          {% if rec.id %}
          <div class="flex justify-center gap-2">
            <a href="/stores/{{ store_id }}/records/{{ rec.id }}/edit" class="text-blue-600 hover:underline">–ò–∑–º–µ–Ω–∏—Ç—å</a>
            {% if user.role == 'admin' %}
            <form method="post" action="/stores/{{ store_id }}/records/{{ rec.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <button type="submit" class="text-red-600 hover:underline">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
            {% endif %}
          </div>
          {% else %}
              ‚Äî
          {% endif %}
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
    {% if user.role in ['manager', 'admin'] %}
    <tfoot>
      <tr class="bg-gray-50 font-semibold">
        <td class="p-2 border text-right">–ò–¢–û–ì–û:</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.z) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.cash_total) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.terminal) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.cash_processed) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.cash_on_hand) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.expenses_total) }}</td>
        <td class="p-2 border"></td>
        <td class="p-2 border"></td>
      </tr>
    </tfoot>
    {% endif %}
  </table>
  {% if user.role in ['manager', 'admin'] %}
  <h4 class="text-lg font-semibold mt-4">üë• –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h4>
  <table class="w-full text-sm border mb-8">
    <thead class="bg-gray-50">
      <tr>
        <th class="p-2 border">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th class="p-2 border">–ü–æ —Å—Ç–∞–≤–∫–µ</th>
        <th class="p-2 border">–í—ã–ø–ª–∞—á–µ–Ω–æ</th>
        <th class="p-2 border">–û—Å—Ç–∞—Ç–æ–∫</th>
        <th class="p-2 border">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for s in data.salaries %}
      <tr>
        <td class="p-2 border">üë§ {{ user_map.get(s.user_id, '‚Äî') }}</td>
        <td class="p-2 border">{{ '%.2f'|format(s.total) }}</td>
        <td class="p-2 border">{{ '%.2f'|format(s.paid) }}</td>
        <td class="p-2 border">{{ '%.2f'|format(s.remaining) }}</td>
        <td class="p-2 border">
          <form method="post" action="/stores/{{ store_id }}/pay">
            <input type="hidden" name="user_id" value="{{ s.user_id }}">
            <input type="hidden" name="date" value="{{ period[0] }}">
            <input type="number" step="0.01" name="amount" placeholder="0.00" class="border p-1 rounded w-24">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="text-green-600 hover:underline">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h4 class="text-lg font-semibold mt-4">üèñ –û—Ç–ø—É—Å–∫–Ω—ã–µ</h4>
  <table class="w-full text-sm border mb-8">
    <thead class="bg-gray-50">
      <tr>
        <th class="p-2 border">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th class="p-2 border">–ü–µ—Ä–∏–æ–¥</th>
        <th class="p-2 border">–°—É–º–º–∞</th>
        {% if user.role in ['manager', 'admin'] %}
        <th class="p-2 border">–î–µ–π—Å—Ç–≤–∏—è</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for v in data.vacations %}
      <tr>
        <td class="p-2 border">üë§ {{ user_map.get(v.user_id, '‚Äî') }}</td>
        <td class="p-2 border">{{ v.start_date }} ‚Äî {{ v.end_date }}</td>
        <td class="p-2 border">{{ '%.2f'|format(v.amount) }}</td>
        {% if user.role in ['manager', 'admin'] %}
        <td class="p-2 border">
          <div class="flex gap-2">
            <a href="/stores/{{ store_id }}/vacations/{{ v.id }}/edit" class="text-blue-600 hover:underline">–ò–∑–º–µ–Ω–∏—Ç—å</a>
            {% if user.role == 'admin' %}
            <form method="post" action="/stores/{{ store_id }}/vacations/{{ v.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç–ø—É—Å–∫?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <button class="text-red-600 hover:underline">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
            {% endif %}
          </div>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
{% endfor %}
<div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
  <div class="bg-white p-4 rounded shadow max-w-md" id="detail-content"></div>
</div>
<script>
document.querySelectorAll('.details-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const data = JSON.parse(btn.dataset.details);
    let html = '<h3 class="text-lg font-semibold mb-2">–î–µ—Ç–∞–ª–∏ —Å–º–µ–Ω—ã</h3><ul class="list-disc pl-4">';
    html += `<li>–ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞: ${parseFloat(data.changed_price).toFixed(2)}</li>`;
    html += `<li>–£—Ü–µ–Ω–∫–∞: ${parseFloat(data.discount).toFixed(2)}</li>`;
    html += `<li>–ê–∫—Ü–∏—è: ${parseFloat(data.promotion).toFixed(2)}</li>`;
    html += `<li>–ù–∞ –º–∞–≥–∞–∑–∏–Ω: ${parseFloat(data.to_store).toFixed(2)}</li>`;
    html += `<li>–í–æ–∑–≤—Ä–∞—Ç: ${parseFloat(data.refund).toFixed(2)}</li>`;
    html += `<li>–°–ª—É–∂–µ–±–Ω–∞—è: ${parseFloat(data.service).toFixed(2)}</li>`;
    html += `<li>–¢–æ–≤–∞—Ä–Ω—ã–π —á–µ–∫: ${parseFloat(data.receipt).toFixed(2)}</li>`;
    html += `<li>–ó–∞—Ä–ø–ª–∞—Ç–∞: ${parseFloat(data.salary_expenses).toFixed(2)}</li>`;
    html += '</ul>';
    document.getElementById('detail-content').innerHTML = html;
    document.getElementById('detail-modal').classList.remove('hidden');
  });
});
document.getElementById('detail-modal').addEventListener('click', e=>{
  if(e.target.id==='detail-modal') e.target.classList.add('hidden');
});
</script>
{% endblock %}
