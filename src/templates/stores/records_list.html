{% extends "base.html" %}
{% block title %}–°–º–µ–Ω—ã –º–∞–≥–∞–∑–∏–Ω–∞{% endblock %}
{% block content %}
<h2 class="text-2xl font-semibold mb-4">üõçÔ∏è –°–º–µ–Ω—ã –∑–∞ {{ month }}/{{ year }} {{ store_name }}</h2>

<a href="/stores/{{ store_id }}/records/create" class="bg-blue-600 text-white px-4 py-2 rounded mb-4 inline-block">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–º–µ–Ω—É</a>

<form method="get" class="mb-6 flex gap-4 items-end">
  <div>
    <label class="block text-sm">–ú–µ—Å—è—Ü</label>
    <input type="number" name="month" value="{{ month }}" min="1" max="12" class="border p-2 rounded w-24">
  </div>
  <div>
    <label class="block text-sm">–ì–æ–¥</label>
    <input type="number" name="year" value="{{ year }}" class="border p-2 rounded w-32">
  </div>
  <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">–ü–æ–∫–∞–∑–∞—Ç—å</button>
</form>

{% for title, data, period in [
  ("1‚Äì15", first_half, first_half_range),
  ("16‚Äì–∫–æ–Ω–µ—Ü", second_half, second_half_range)
] %}
  <h3 class="text-xl font-semibold mt-8 mb-2">üóì –ü–µ—Ä–∏–æ–¥: {{ period[0] }} ‚Äî {{ period[1] }} ({{ title }})</h3>

  <table class="w-full text-sm border">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 border text-left">–î–∞—Ç–∞</th>
        {% if user.role in ['manager', 'admin'] %}
        <th class="p-2 border text-right">–ò—Ç–æ–≥–æ–≤–∞—è –∫–∞—Å—Å–∞ (Z)</th>
        <th class="p-2 border text-right">–¢–µ—Ä–º–∏–Ω–∞–ª</th>
        <th class="p-2 border text-right">–ù–∞–ª–∏—á–Ω—ã–µ –ø–æ –∫–∞—Å—Å–µ</th>
        <th class="p-2 border text-right">–ù–∞–ª–∏—á–Ω—ã–µ –≤ –∫–∞—Å—Å–µ (–∫–æ–Ω–µ—Ü)</th>
        {% endif %}
        <th class="p-2 border text-left">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</th>
        {% if user.role in ['manager', 'admin'] %}
        <th class="p-2 border text-center">–ü—Ä–∞–≤–∫–∞</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for rec in data.days %}
      <tr>
        <td class="p-2 border whitespace-nowrap">{{ rec.date }}</td>
        {% if user.role in ['manager', 'admin'] %}
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.cash) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.terminal) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.cash_processed) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(rec.cash_on_hand) }}</td>
        {% endif %}
        <td class="p-2 border">
          {% for e in rec.employees %}
            {{ user_map.get(e.id, '‚Äî') }}{% if e.is_warehouse %} (—Å–∫–ª–∞–¥){% endif %}<br>
          {% endfor %}
        </td>
        {% if user.role in ['manager', 'admin'] %}
        <td class="p-2 border">
          {% if rec.id %}
          <div class="flex justify-center gap-2">
            <a href="/stores/{{ store_id }}/records/{{ rec.id }}/edit" class="text-blue-600 hover:underline">–ò–∑–º–µ–Ω–∏—Ç—å</a>
            {% if user.role == 'admin' %}
            <form method="post" action="/stores/{{ store_id }}/records/{{ rec.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <button type="submit" class="text-red-600 hover:underline">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
            {% endif %}
          </div>
          {% else %}
              ‚Äî
          {% endif %}
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
    {% if user.role in ['manager', 'admin'] %}
    <tfoot>
      <tr class="bg-gray-50 font-semibold">
        <td class="p-2 border text-right">–ò–¢–û–ì–û:</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.z) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.terminal) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.cash_processed) }}</td>
        <td class="p-2 border text-right">{{ '%.2f'|format(data.totals.cash_on_hand) }}</td>
        <td class="p-2 border"></td>
        <td class="p-2 border"></td>
      </tr>
    </tfoot>
    {% endif %}
  </table>
  {% if user.role in ['manager', 'admin'] %}
  <h4 class="text-lg font-semibold mt-4">üë• –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h4>
  <table class="w-full text-sm border mb-8">
    <thead class="bg-gray-50">
      <tr>
        <th class="p-2 border">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th class="p-2 border">–ü–æ —Å—Ç–∞–≤–∫–µ</th>
        <th class="p-2 border">–í—ã–ø–ª–∞—á–µ–Ω–æ</th>
        <th class="p-2 border">–û—Å—Ç–∞—Ç–æ–∫</th>
        <th class="p-2 border">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for s in data.salaries %}
      <tr>
        <td class="p-2 border">üë§ {{ user_map.get(s.user_id, '‚Äî') }}</td>
        <td class="p-2 border">{{ '%.2f'|format(s.total) }}</td>
        <td class="p-2 border">{{ '%.2f'|format(s.paid) }}</td>
        <td class="p-2 border">{{ '%.2f'|format(s.remaining) }}</td>
        <td class="p-2 border">
          <form method="post" action="/stores/{{ store_id }}/pay">
            <input type="hidden" name="user_id" value="{{ s.user_id }}">
            <input type="hidden" name="date" value="{{ period[0] }}">
            <input type="number" step="0.01" name="amount" placeholder="0.00" class="border p-1 rounded w-24">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="text-green-600 hover:underline">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
{% endfor %}
{% endblock %}
