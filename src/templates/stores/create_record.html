{% extends "base.html" %}
{% block title %}–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å{% endblock %}
{% block content %}
<div class="max-w-lg mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h2>
  <form method="post" class="flex flex-col gap-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <label>–î–∞—Ç–∞</label>
    <input type="date" name="date_" required class="border p-2 rounded" />

    <label>–ò—Ç–æ–≥–æ–≤–∞—è –∫–∞—Å—Å–∞ (Z)</label>
    <input type="number" step="0.01" name="cash" required class="border p-2 rounded" />
    <input type="text" name="cash_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–û—Å—Ç–∞—Ç–æ–∫</label>
    <input type="number" step="0.01" name="cash_on_hand" required class="border p-2 rounded" />
    <input type="text" name="cash_on_hand_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–¢–µ—Ä–º–∏–Ω–∞–ª</label>
    <input type="number" step="0.01" name="terminal" required class="border p-2 rounded" />
    <input type="text" name="terminal_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–ò–∑–º–µ–Ω–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞</label>
    <input type="number" step="0.01" name="changed_price" class="border p-2 rounded" />
    <input type="text" name="changed_price_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–£—Ü–µ–Ω–∫–∞</label>
    <input type="number" step="0.01" name="discount" class="border p-2 rounded" />
    <input type="text" name="discount_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–ê–∫—Ü–∏—è</label>
    <input type="number" step="0.01" name="promotion" class="border p-2 rounded" />
    <input type="text" name="promotion_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–ù–∞ –º–∞–≥–∞–∑–∏–Ω</label>
    <input type="number" step="0.01" name="to_store" class="border p-2 rounded" />
    <input type="text" name="to_store_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–í–æ–∑–≤—Ä–∞—Ç</label>
    <input type="number" step="0.01" name="refund" class="border p-2 rounded" />
    <input type="text" name="refund_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–°–ª—É–∂–µ–±–Ω–∞—è</label>
    <input type="number" step="0.01" name="service" class="border p-2 rounded" />
    <input type="text" name="service_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–¢–æ–≤–∞—Ä–Ω—ã–π —á–µ–∫</label>
    <input type="number" step="0.01" name="receipt" class="border p-2 rounded" />
    <input type="text" name="receipt_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border p-2 rounded" />

    <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞</label>
    <select id="store-select" name="store_employees" multiple class="border p-2 rounded h-40">
      {% for emp in store_employees %}
      <option value="{{ emp.id }}" data-rate="{{ emp.default_rate }}" data-start="{{ emp.shift_start.strftime('%H:%M') }}" data-end="{{ emp.shift_end.strftime('%H:%M') }}">{{ emp.name | e }}</option>
      {% endfor %}
    </select>
    <div id="store-assignments" class="flex flex-col gap-4"></div>

    <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å–∫–ª–∞–¥–∞</label>
    <select id="warehouse-select" name="warehouse_employees" multiple class="border p-2 rounded h-40">
      <option value="">---</option>
      {% for emp in warehouse_employees %}
      <option value="{{ emp.id }}" data-rate="{{ emp.default_rate }}" data-start="{{ emp.shift_start.strftime('%H:%M') }}" data-end="{{ emp.shift_end.strftime('%H:%M') }}">{{ emp.name | e }}</option>
      {% endfor %}
    </select>
    <div id="warehouse-assignments" class="flex flex-col gap-4"></div>

    <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ –∏—Ç–æ–≥–æ</label>
    <input type="number" name="salary_expenses" id="salary-total" value="0" readonly class="border p-2 rounded" />

    <button type="submit" class="bg-green-600 text-white py-2 rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </form>
</div>
<script>
function parseTime(t){
  const [h,m] = t.split(':');
  return new Date(0,0,0,h,m).getTime();
}

function setupSelect(selectId, assignmentsId){
  const select = document.getElementById(selectId);
  const assignmentsDiv = document.getElementById(assignmentsId);
  const handler = () => updateAssignments(select, assignmentsDiv);
  select.addEventListener('change', handler);
  handler();
}

function updateAssignments(select, assignmentsDiv){
  const selected = Array.from(select.selectedOptions);
  const existingIds = Array.from(assignmentsDiv.children).map(d => d.dataset.userId);
  existingIds.forEach(id => {
    if(!selected.find(opt => opt.value === id)){
      assignmentsDiv.querySelector(`div[data-user-id="${id}"]`).remove();
    }
  });
  selected.forEach(opt => {
    const id = opt.value;
    if (!id) return; // üëà –ø—Ä–æ–ø—É—Å–∫–∞–µ–º "---"

    if(assignmentsDiv.querySelector(`div[data-user-id="${id}"]`)) return;
    const rate = parseFloat(opt.dataset.rate || 0);
    const defStart = opt.dataset.start;
    const defEnd = opt.dataset.end;
    const container = document.createElement('div');
    container.className = 'assignment border p-2 rounded';
    container.dataset.userId = id;
    container.innerHTML = `
      <p class="font-semibold">${opt.text}</p>
      <label>–ù–∞—á–∞–ª–æ</label>
      <input type="time" name="start_time_${id}" value="${defStart}" class="border p-1 rounded start">
      <label>–ö–æ–Ω–µ—Ü</label>
      <input type="time" name="end_time_${id}" value="${defEnd}" class="border p-1 rounded end">
      <label>–°—Ç–∞–≤–∫–∞</label>
      <input type="number" step="1" class="border p-1 rounded amount" value="${Math.round(rate)}" readonly>
    `;
    assignmentsDiv.appendChild(container);

    const startInput = container.querySelector('.start');
    const endInput = container.querySelector('.end');
    const amountInput = container.querySelector('.amount');
    function recalc(){
      if(!startInput.value || !endInput.value) return;
      const workHours = (parseTime(endInput.value) - parseTime(startInput.value)) / 3600000;
      const defHours = (parseTime(defEnd) - parseTime(defStart)) / 3600000;
      amountInput.value = Math.round(rate * (workHours/defHours));
      recalcTotal();
    }
    startInput.addEventListener('change', recalc);
    endInput.addEventListener('change', recalc);
    recalc();
  });
}

function recalcTotal(){
  let total = 0;
  document.querySelectorAll('.amount').forEach(i => total += parseFloat(i.value||0));
  document.getElementById('salary-total').value = Math.round(total);
}

setupSelect('store-select', 'store-assignments');
setupSelect('warehouse-select', 'warehouse-assignments');
</script>
{% endblock %}
