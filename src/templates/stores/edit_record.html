{% extends "base.html" %}
{% block title %}Изменить запись{% endblock %}
{% block content %}
<div class="max-w-lg mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-xl font-semibold mb-4">Изменить запись</h2>
  <form method="post" class="flex flex-col gap-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <!-- Дата (только для просмотра) -->
    <input type="date" name="date_" value="{{ record.date }}" required class="border p-2 rounded" readonly />

    <!-- Поля ввода сумм -->
    <input type="number" step="0.01" name="cash" value="{{ record.cash }}" required class="border p-2 rounded" />
    {% if record.cash or record.comments.get('cash') %}
    <input type="text" name="cash_comment" value="{{ record.comments.get('cash','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="cash_on_hand" value="{{ record.cash_on_hand }}" required class="border p-2 rounded" />
    {% if record.cash_on_hand or record.comments.get('cash_on_hand') %}
    <input type="text" name="cash_on_hand_comment" value="{{ record.comments.get('cash_on_hand','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="terminal" value="{{ record.terminal }}" required class="border p-2 rounded" />
    {% if record.terminal or record.comments.get('terminal') %}
    <input type="text" name="terminal_comment" value="{{ record.comments.get('terminal','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="changed_price" value="{{ record.changed_price }}" class="border p-2 rounded" />
    {% if record.changed_price or record.comments.get('changed_price') %}
    <input type="text" name="changed_price_comment" value="{{ record.comments.get('changed_price','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="discount" value="{{ record.discount }}" class="border p-2 rounded" />
    {% if record.discount or record.comments.get('discount') %}
    <input type="text" name="discount_comment" value="{{ record.comments.get('discount','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="promotion" value="{{ record.promotion }}" class="border p-2 rounded" />
    {% if record.promotion or record.comments.get('promotion') %}
    <input type="text" name="promotion_comment" value="{{ record.comments.get('promotion','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="to_store" value="{{ record.to_store }}" class="border p-2 rounded" />
    {% if record.to_store or record.comments.get('to_store') %}
    <input type="text" name="to_store_comment" value="{{ record.comments.get('to_store','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="refund" value="{{ record.refund }}" class="border p-2 rounded" />
    {% if record.refund or record.comments.get('refund') %}
    <input type="text" name="refund_comment" value="{{ record.comments.get('refund','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="service" value="{{ record.service }}" class="border p-2 rounded" />
    {% if record.service or record.comments.get('service') %}
    <input type="text" name="service_comment" value="{{ record.comments.get('service','') }}" class="border p-2 rounded" />
    {% endif %}

    <input type="number" step="0.01" name="receipt" value="{{ record.receipt }}" class="border p-2 rounded" />
    {% if record.receipt or record.comments.get('receipt') %}
    <input type="text" name="receipt_comment" value="{{ record.comments.get('receipt','') }}" class="border p-2 rounded" />
    {% endif %}

    <!-- Сотрудники магазина -->
    <label>Сотрудники магазина</label>
    <select id="store-select" name="store_employees" multiple required class="border p-2 rounded h-40">
      {% for emp in store_employees %}
      <option value="{{ emp.id }}" data-rate="{{ emp.default_rate }}" data-start="{{ emp.shift_start.strftime('%H:%M') }}" data-end="{{ emp.shift_end.strftime('%H:%M') }}" {% if emp.id in selected_store %}selected{% endif %} {% if emp.id in vacation_users %}disabled class="bg-gray-100"{% endif %}>{{ emp.name | e }}{% if emp.id in vacation_users %} (отпуск){% endif %}</option>
      {% endfor %}
    </select>
    <div id="store-assignments" class="flex flex-col gap-4"></div>

    <!-- Сотрудники склада -->
    <label>Сотрудники склада</label>
    <select id="warehouse-select" name="warehouse_employees" multiple required class="border p-2 rounded h-40">
      <option value="">---</option>
      {% for emp in warehouse_employees %}
      <option value="{{ emp.id }}" data-rate="{{ emp.default_rate }}" data-start="{{ emp.shift_start.strftime('%H:%M') }}" data-end="{{ emp.shift_end.strftime('%H:%M') }}" {% if emp.id in selected_warehouse %}selected{% endif %} {% if emp.id in vacation_users %}disabled class="bg-gray-100"{% endif %}>{{ emp.name | e }}{% if emp.id in vacation_users %} (отпуск){% endif %}</option>
      {% endfor %}
    </select>
    <div id="warehouse-assignments" class="flex flex-col gap-4"></div>

    <label>Зарплата итого</label>
    <input type="number" name="salary_expenses" id="salary-total" value="{{ record.salary_expenses }}" readonly class="border p-2 rounded" />

    <button type="submit" class="bg-green-600 text-white py-2 rounded hover:bg-green-700">Сохранить</button>
  </form>
</div>
<script>
function parseTime(t){
  const [h,m] = t.split(':');
  return new Date(0,0,0,h,m).getTime();
}

function setupSelect(selectId, assignmentsId){
  const select = document.getElementById(selectId);
  const assignmentsDiv = document.getElementById(assignmentsId);
  const handler = () => updateAssignments(select, assignmentsDiv);
  select.addEventListener('change', handler);
  handler();
}

function updateAssignments(select, assignmentsDiv){
  const selected = Array.from(select.selectedOptions);
  const existingIds = Array.from(assignmentsDiv.children).map(d => d.dataset.userId);
  existingIds.forEach(id => {
    if(!selected.find(opt => opt.value === id)){
      assignmentsDiv.querySelector(`div[data-user-id="${id}"]`).remove();
    }
  });
  selected.forEach(opt => {
    const id = opt.value;
    if(assignmentsDiv.querySelector(`div[data-user-id="${id}"]`)) return;
    const rate = parseFloat(opt.dataset.rate || 0);
    const defStart = opt.dataset.start;
    const defEnd = opt.dataset.end;
    const container = document.createElement('div');
    container.className = 'assignment border p-2 rounded';
    container.dataset.userId = id;
    container.innerHTML = `
      <p class=\"font-semibold\">${opt.text}</p>
      <label>Начало</label>
      <input type="time" name="start_time_${id}" value="${defStart}" class="border p-1 rounded start">
      <label>Конец</label>
      <input type="time" name="end_time_${id}" value="${defEnd}" class="border p-1 rounded end">
      <label>Ставка</label>
      <input type="number" step="1" class="border p-1 rounded amount" value="${Math.round(rate)}" readonly>
    `;
    assignmentsDiv.appendChild(container);
    const startInput = container.querySelector('.start');
    const endInput = container.querySelector('.end');
    const amountInput = container.querySelector('.amount');
    function recalc(){
      if(!startInput.value || !endInput.value) return;
      const workHours = (parseTime(endInput.value) - parseTime(startInput.value)) / 3600000;
      const defHours = (parseTime(defEnd) - parseTime(defStart)) / 3600000;
      amountInput.value = Math.round(rate * (workHours/defHours));
      recalcTotal();
    }
    startInput.addEventListener('change', recalc);
    endInput.addEventListener('change', recalc);
    recalc();
  });
}

function recalcTotal(){
  let total = 0;
  document.querySelectorAll('.amount').forEach(i => total += parseFloat(i.value||0));
  document.getElementById('salary-total').value = Math.round(total);
}

setupSelect('store-select', 'store-assignments');
setupSelect('warehouse-select', 'warehouse-assignments');
</script>
{% endblock %}
