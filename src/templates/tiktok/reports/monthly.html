{% extends "base.html" %}
{% block title %}–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç{% endblock %}

{% block content %}
<h2 class="text-2xl font-semibold mb-4">üìä –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç –∑–∞ {{ month | e }}/{{ year | e }}</h2>

<!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –º–µ—Å—è—Ü–∞ –∏ —Ç–æ—á–∫–∏ -->
<form method="get" class="mb-6 flex gap-4 items-end flex-wrap">
  <div>
    <label class="block text-sm">–ú–µ—Å—è—Ü</label>
    <input type="number" name="month" value="{{ month }}" min="1" max="12" class="border p-2 rounded w-24">
  </div>
  <div>
    <label class="block text-sm">–ì–æ–¥</label>
    <input type="number" name="year" value="{{ year }}" class="border p-2 rounded w-32">
  </div>
  {% if branches and branches|length > 0 %}
  <div>
    <label class="block text-sm">TikTok —Ç–æ—á–∫–∞</label>
    <select name="branch_id" class="border p-2 rounded">
      <option value="">–í—Å–µ —Ç–æ—á–∫–∏</option>
      {% for branch in branches %}
      <option value="{{ branch.id }}" {% if branch.id == selected_branch_id %}selected{% endif %}>
        {{ branch.name }}
      </option>
      {% endfor %}
    </select>
  </div>
  {% endif %}
  <input type="hidden" name="period_mode" value="{{ period_mode }}">
  <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">–ü–æ–∫–∞–∑–∞—Ç—å</button>
</form>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–∏–æ–¥–æ–≤ -->
<div class="mb-6 flex gap-3 flex-wrap">
  <a href="?month={{ month }}&year={{ year }}&period_mode=new{% if selected_branch_id %}&branch_id={{ selected_branch_id }}{% endif %}"
     class="px-4 py-2 rounded {% if period_mode == 'new' %}bg-green-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
    üÜï –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (1-7, 8-14, 15-21, 22-–∫–æ–Ω–µ—Ü)
  </a>
  <a href="?month={{ month }}&year={{ year }}&period_mode=old{% if selected_branch_id %}&branch_id={{ selected_branch_id }}{% endif %}"
     class="px-4 py-2 rounded {% if period_mode == 'old' %}bg-green-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
    üìÖ –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (1-15, 16-–∫–æ–Ω–µ—Ü)
  </a>
  <button onclick="toggleCustomPeriod()"
     class="px-4 py-2 rounded {% if period_mode == 'custom' %}bg-green-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
    üìÜ –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
  </button>
</div>

<!-- –§–æ—Ä–º–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ -->
<div id="customPeriodForm" class="mb-6 p-4 border rounded bg-gray-50 {% if period_mode != 'custom' %}hidden{% endif %}">
  <form method="get" class="flex gap-4 items-end flex-wrap">
    <div>
      <label class="block text-sm font-medium">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
      <input type="date" name="custom_start" value="{{ custom_start or '' }}" required class="border p-2 rounded">
    </div>
    <div>
      <label class="block text-sm font-medium">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
      <input type="date" name="custom_end" value="{{ custom_end or '' }}" required class="border p-2 rounded">
    </div>
    {% if branches and branches|length > 0 %}
    <div>
      <label class="block text-sm font-medium">TikTok —Ç–æ—á–∫–∞</label>
      <select name="branch_id" class="border p-2 rounded">
        <option value="">–í—Å–µ —Ç–æ—á–∫–∏</option>
        {% for branch in branches %}
        <option value="{{ branch.id }}" {% if branch.id == selected_branch_id %}selected{% endif %}>
          {{ branch.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <input type="hidden" name="period_mode" value="custom">
    <button class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–∏–æ–¥</button>
  </form>
</div>

<script>
function toggleCustomPeriod() {
  const form = document.getElementById('customPeriodForm');
  form.classList.toggle('hidden');
}
</script>

<!-- –ë–ª–æ–∫ –æ—Ç—á—ë—Ç–∞ -->
{% for title, data, period in periods %}
<h3 class="text-xl font-semibold mt-8 mb-2">üóì –ü–µ—Ä–∏–æ–¥: {{ period[0] | e }} ‚Äî {{ period[1] | e }} ({{ title | e }})</h3>

<table class="w-full text-sm border">
  <thead class="bg-gray-100">
    <tr>
      <th class="p-2 border">–î–∞—Ç–∞</th>
      <th class="p-2 border">–ö–∞—Å—Å–∞</th>
      <th class="p-2 border">–í–æ–∑–≤—Ä–∞—Ç—ã</th>
      <th class="p-2 border">–ò—Ç–æ–≥</th>
      <th class="p-2 border">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</th>
      <th class="p-2 border">–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody>
    {% set ns = namespace(total_cash=0.0, total_returns=0.0) %}
    {% for day in data.days %}
    <tr>
      <td class="p-2 border">{{ day.date | e }}</td>
      <td class="p-2 border">{{ "%.2f"|format(day.orders) | e }}</td>
      <td class="p-2 border">{{ "%.2f"|format(day.returns) | e }}</td>
      <td class="p-2 border">{{ "%.2f"|format(day.cashbox) | e }}</td>
      <td class="p-2 border">
        <ul class="list-disc list-inside">
        {% for e in day.employees %}
          <li>
            <span class="font-medium">{{ user_map.get(e.user_id, "‚Äî") | e }}</span>
            <span class="text-gray-500 text-xs">({{ e.start_time.strftime("%H:%M") }}‚Äì{{ e.end_time.strftime("%H:%M") }})</span>
            <span class="ml-1">{{ "%.0f"|format(e.salary) }}</span>
          </li>
        {% endfor %}
        </ul>
      </td>
      <td class="p-2 border text-center">
        {% if day.shift_id and day.employees %}
          {% set ret = '/reports/monthly?month=' ~ month ~ '&year=' ~ year %}
          <a href="/shifts/{{ day.shift_id }}/edit?return_url={{ ret | urlencode }}" class="text-blue-600 hover:underline">–ò–∑–º–µ–Ω–∏—Ç—å</a>
        {% else %}
          ‚Äî
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot class="bg-gray-100 font-semibold">
    <tr>
      <td class="p-2 border text-right">–ò–¢–û–ì–û:</td>
      <td class="p-2 border">{{ "%.2f"|format(data.totals.orders) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(data.totals.returns) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(data.totals.cashbox) }}</td>
      <td class="p-2 border" colspan="2"></td>
    </tr>
  </tfoot>
</table>


<!-- –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ç–∏–ø–∞–º –∑–∞–∫–∞–∑–æ–≤ -->
{% if data.types_breakdown %}
<h4 class="text-lg font-semibold mt-6 mb-2">üì¶ –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∑–∞–∫–∞–∑–æ–≤</h4>
<table class="w-full text-sm border mb-4">
  <thead class="bg-gray-50">
    <tr>
      <th class="p-2 border">–¢–∏–ø –∑–∞–∫–∞–∑–∞</th>
      <th class="p-2 border">–°—É–º–º–∞</th>
      <th class="p-2 border">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
    </tr>
  </thead>
  <tbody>
    {% for type_item in data.types_breakdown %}
    <tr>
      <td class="p-2 border">{{ type_item.type_name | e }}</td>
      <td class="p-2 border">{{ "%.2f"|format(type_item.amount) }}</td>
      <td class="p-2 border">{{ type_item.count }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<!-- –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º -->
{% if data.creators_breakdown %}
<h4 class="text-lg font-semibold mt-4 mb-2">üíº –ö–∞—Å—Å–∞ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º</h4>
<table class="w-full text-sm border mb-4">
  <thead class="bg-gray-50">
    <tr>
      <th class="p-2 border">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
      <th class="p-2 border">–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤</th>
      <th class="p-2 border">–í–æ–∑–≤—Ä–∞—Ç—ã</th>
      <th class="p-2 border">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
    </tr>
  </thead>
  <tbody>
    {% for creator in data.creators_breakdown %}
    <tr>
      <td class="p-2 border">{{ creator.name | e }}</td>
      <td class="p-2 border">{{ "%.2f"|format(creator.amount) }}</td>
      <td class="p-2 border {% if creator.returns > 0 %}text-red-600{% endif %}">
        {% if creator.returns > 0 %}-{% endif %}{{ "%.2f"|format(creator.returns) }}
      </td>
      <td class="p-2 border">{{ creator.count }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<!-- –ë–ª–æ–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º -->
<h4 class="text-lg font-semibold mt-4">üë• –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º (—Å—Ç–∞–≤–∫–∞ + % - —à—Ç—Ä–∞—Ñ—ã)</h4>

<table class="w-full text-sm border mb-8">
  <thead class="bg-gray-50">
    <tr>
        <th class="p-2 border">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th class="p-2 border">–ü–æ —Å—Ç–∞–≤–∫–µ</th>
        <th class="p-2 border">–ü—Ä–æ—Ü–µ–Ω—Ç</th>
        <th class="p-2 border">–®—Ç—Ä–∞—Ñ—ã</th>
        <th class="p-2 border">–ò—Ç–æ–≥–æ</th>
        <th class="p-2 border">–í—ã–ø–ª–∞—á–µ–Ω–æ</th>
        <th class="p-2 border">–û—Å—Ç–∞–ª–æ—Å—å</th>
        <th class="p-2 border">–î–æ–ø–ª–∞—Ç–∏—Ç—å</th>
    </tr>
  </thead>
  <tbody>
    {% for s in data.salaries %}
    <tr>
      <td class="p-2 border">üë§ {{ user_map.get(s.user_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") | e }}</td>
      <td class="p-2 border">{{ "%.2f"|format(s.fixed) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(s.percent) }}</td>
      <td class="p-2 border {% if s.penalties > 0 %}text-red-600 font-semibold{% endif %}">
        {% if s.penalties > 0 %}-{% endif %}{{ "%.2f"|format(s.penalties) }}
      </td>
      <td class="p-2 border font-semibold">{{ "%.2f"|format(s.total) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(s.paid) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(s.remaining) }}</td>
      <td class="p-2 border">
          <form method="post" action="/reports/pay">
          <input type="hidden" name="user_id" value="{{ s.user_id }}">
          <input type="hidden" name="date" value="{{ period[0] }}">
          <input type="number" step="0.01" name="amount" placeholder="0.00" class="border p-1 rounded w-24">
          <button class="text-green-600 hover:underline">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button>
          </form>
      </td>
    </tr>
    {% endfor %}

  </tbody>
</table>
{% endfor %}

{% endblock %}
