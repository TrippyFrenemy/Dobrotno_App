{% extends "base.html" %}
{% block title %}Редактировать смену{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-xl font-semibold mb-4">Редактировать смену</h2>
  <form method="post" class="flex flex-col gap-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <label>Дата</label>
    <input type="date" name="date_" value="{{ shift.date }}" required class="border p-2 rounded" readonly>

    <label>Локация</label>
    <select name="location" class="border p-2 rounded">
      {% for loc in locations %}
      <option value="{{ loc.value }}" {% if loc.value == shift.location.value %}selected{% endif %}>{{ loc.value | e }}</option>
      {% endfor %}
    </select>

    <label>Сотрудники</label>
    <select name="employees" multiple required class="border p-2 rounded h-40" id="employee-select">
      {% for u in users %}
      {% if u.is_active %}
      <option value="{{ u.id }}" data-rate="{{ u.default_rate }}" data-start="{{ u.shift_start.strftime('%H:%M') }}" data-end="{{ u.shift_end.strftime('%H:%M') }}" {% if u.id in assigned_ids %}selected{% endif %}>{{ u.name | e }}</option>
      {% endif %}
      {% endfor %}
    </select>

    <div id="assignments" class="flex flex-col gap-4">
      {% for a in shift.assignments %}
      <div class="assignment border p-2 rounded" data-user-id="{{ a.user_id }}">
        <p class="font-semibold">{{ a.user.name | e }}</p>
        <label>Начало</label>
        <input type="time" name="start_time_{{ a.user_id }}" value="{{ a.start_time.strftime('%H:%M') if a.start_time else a.user.shift_start.strftime('%H:%M') }}" class="border p-1 rounded start">
        <label>Конец</label>
        <input type="time" name="end_time_{{ a.user_id }}" value="{{ a.end_time.strftime('%H:%M') if a.end_time else a.user.shift_end.strftime('%H:%M') }}" class="border p-1 rounded end">
        <label>Ставка (грн)</label>
        <input type="number" step="1" name="amount_{{ a.user_id }}" value="{{ (a.salary if a.salary else a.user.default_rate)|round|int }}" class="border p-1 rounded amount" readonly>
      </div>
      {% endfor %}
    </div>

    <button class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Сохранить</button>
  </form>
</div>
<script>
const employeeSelect = document.getElementById('employee-select');
const assignmentsDiv = document.getElementById('assignments');

function parseTime(t){
  const [h,m] = t.split(':');
  return new Date(0,0,0,h,m).getTime();
}

function updateAssignments(){
  const selected = Array.from(employeeSelect.selectedOptions);
  const existingIds = Array.from(assignmentsDiv.children).map(div => div.dataset.userId);
  existingIds.forEach(id => {
    if(!selected.find(opt => opt.value === id)){
      assignmentsDiv.querySelector(`div[data-user-id="${id}"]`).remove();
    }
  });
  selected.forEach(opt => {
    const id = opt.value;
    if(assignmentsDiv.querySelector(`div[data-user-id="${id}"]`)) return;
    const rate = parseFloat(opt.dataset.rate || 0);
    const defStart = opt.dataset.start;
    const defEnd = opt.dataset.end;
    const container = document.createElement('div');
    container.className = 'assignment border p-2 rounded';
    container.dataset.userId = id;
    container.innerHTML = `
      <p class="font-semibold">${opt.text}</p>
      <label>Начало</label>
      <input type="time" name="start_time_${id}" value="${defStart}" class="border p-1 rounded start">
      <label>Конец</label>
      <input type="time" name="end_time_${id}" value="${defEnd}" class="border p-1 rounded end">
      <label>Ставка (грн)</label>
      <input type="number" step="1" name="amount_${id}" value="${Math.round(rate)}" class="border p-1 rounded amount" readonly>
    `;
    assignmentsDiv.appendChild(container);

    const startInput = container.querySelector('.start');
    const endInput = container.querySelector('.end');
    const amountInput = container.querySelector('.amount');

    function recalc(){
      if(!startInput.value || !endInput.value) return;
      const workHours = (parseTime(endInput.value) - parseTime(startInput.value)) / 3600000;
      const defHours = (parseTime(defEnd) - parseTime(defStart)) / 3600000;
      amountInput.value = Math.round(rate * (workHours/defHours));
    }
    startInput.addEventListener('change', recalc);
    endInput.addEventListener('change', recalc);
  });
}

employeeSelect.addEventListener('change', updateAssignments);
</script>
{% endblock %}
