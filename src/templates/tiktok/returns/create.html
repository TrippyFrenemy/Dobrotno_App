{% extends "base.html" %}
{% block title %}Добавить возврат{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-xl font-semibold mb-4">Добавить возврат</h2>
  <form method="post" class="flex flex-col gap-4" id="returnForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Дата возврата <span class="text-red-500">*</span></label>
      <input type="date" name="date_" id="returnDate" required class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Сумма возврата (грн) <span class="text-red-500">*</span></label>
      <input type="number" step="0.01" name="amount" placeholder="Сумма возврата (грн)" required class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Причина</label>
      <textarea name="reason" placeholder="Причина (необязательно)" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500"></textarea>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Связанный заказ <span class="text-red-500">*</span></label>
      <select name="order_id" id="orderSelect" required class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500">
        <option value="">Выберите заказ</option>
        {% for order in orders %}
        <option value="{{ order.id }}" data-order-date="{{ order.date }}">
          Заказ #{{ order.id }} - {{ order.date }} - {{ order.phone_number }} - {{ order.amount }} грн ({{ order.created_by_user.name }})
        </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Сумма штрафа (грн)</label>
      <input type="number" step="0.01" name="penalty_amount" id="penaltyAmount" placeholder="0.00" value="0.00" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
      <p class="text-xs text-gray-500 mt-1">Если указан штраф, необходимо выбрать сотрудников</p>
    </div>

    <div id="employeesSection">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Сотрудники для назначения штрафа
        <span id="requiredStar" class="text-red-500 hidden">*</span>
      </label>
      <div class="border border-gray-300 rounded p-3 max-h-48 overflow-y-auto">
        {% for employee in employees %}
        <div class="flex items-center mb-2">
          <input type="checkbox" name="selected_employees" value="{{ employee.id }}" id="emp_{{ employee.id }}" class="employee-checkbox mr-2">
          <label for="emp_{{ employee.id }}" class="text-sm">{{ employee.name }} ({{ employee.role }})</label>
        </div>
        {% endfor %}
      </div>
      <p class="text-xs text-gray-500 mt-1">Штраф будет разделён поровну между выбранными сотрудниками</p>
    </div>

    <div id="errorMessage" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-2 rounded">
      Если указан штраф, необходимо выбрать хотя бы одного сотрудника
    </div>

    <button type="submit" class="bg-red-600 text-white py-2 rounded hover:bg-red-700">Сохранить</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const penaltyInput = document.getElementById("penaltyAmount");
  const requiredStar = document.getElementById("requiredStar");
  const form = document.getElementById("returnForm");
  const errorMessage = document.getElementById("errorMessage");
  const returnDateInput = document.getElementById("returnDate");
  const orderSelect = document.getElementById("orderSelect");

  // Сохраняем все опции заказов
  const allOrderOptions = Array.from(orderSelect.options).slice(1); // Убираем первую опцию "Не указан"

  // Фильтрация заказов по выбранной дате
  returnDateInput.addEventListener("change", () => {
    const selectedDate = returnDateInput.value;

    // Удаляем все опции кроме первой ("Выберите заказ")
    while (orderSelect.options.length > 1) {
      orderSelect.remove(1);
    }

    if (selectedDate) {
      // Добавляем только заказы с выбранной датой
      allOrderOptions.forEach(option => {
        if (option.dataset.orderDate === selectedDate) {
          orderSelect.appendChild(option.cloneNode(true));
        }
      });

      // Если нет заказов на эту дату, показываем сообщение
      if (orderSelect.options.length === 1) {
        const noOrdersOption = document.createElement('option');
        noOrdersOption.value = '';
        noOrdersOption.textContent = 'Нет заказов на эту дату';
        noOrdersOption.disabled = true;
        orderSelect.appendChild(noOrdersOption);
      }
    } else {
      // Если дата не выбрана, показываем все заказы
      allOrderOptions.forEach(option => {
        orderSelect.appendChild(option.cloneNode(true));
      });
    }
  });
});
</script>
{% endblock %}
