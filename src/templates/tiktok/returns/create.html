{% extends "base.html" %}
{% block title %}–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç{% endblock %}
{% block head %}
<script src="https://unpkg.com/inputmask@5.0.8/dist/inputmask.min.js"></script>
{% endblock %}
{% block content %}
<div class="max-w-lg mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç</h2>
  <form method="post" class="flex flex-col gap-4" id="returnForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ <span class="text-red-500">*</span></label>
      <input type="date" name="date_" id="returnDate" required class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">–°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–≥—Ä–Ω) <span class="text-red-500">*</span></label>
      <input type="number" step="0.01" name="amount" placeholder="–°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–≥—Ä–Ω)" required class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏—á–∏–Ω–∞</label>
      <textarea name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500"></textarea>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">–°–≤—è–∑–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑ <span class="text-red-500">*</span></label>

      <!-- –ü–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
      <div class="mb-2 flex gap-2">
        <input type="text" id="phoneSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É..." class="flex-1 border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500">
        <select id="orderSort" class="border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500">
          <option value="date_desc">–ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ)</option>
          <option value="date_asc">–ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ)</option>
          <option value="amount_desc">–ü–æ —Å—É–º–º–µ (–±–æ–ª—å—à–µ)</option>
          <option value="amount_asc">–ü–æ —Å—É–º–º–µ (–º–µ–Ω—å—à–µ)</option>
          <option value="created_desc">–ü–æ —Å–æ–∑–¥–∞–Ω–∏—é (–Ω–æ–≤—ã–µ)</option>
          <option value="created_asc">–ü–æ —Å–æ–∑–¥–∞–Ω–∏—é (—Å—Ç–∞—Ä—ã–µ)</option>
        </select>
      </div>

      <select name="order_id" id="orderSelect" required class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" size="8">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑</option>
        {% for order in orders %}
        <option value="{{ order.id }}"
                data-order-date="{{ order.date.isoformat() }}"
                data-phone="{{ order.phone_number }}"
                data-amount="{{ order.amount }}"
                data-created="{{ order.created_at.isoformat() if order.created_at else '' }}">
          –ó–∞–∫–∞–∑ #{{ order.id }} - {{ order.date }} - {{ order.phone_number }} - {{ order.amount }} –≥—Ä–Ω ({{ order.created_by_user.name }})
        </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">–°—É–º–º–∞ —à—Ç—Ä–∞—Ñ–∞ (–≥—Ä–Ω)</label>
      <input type="number" step="0.01" name="penalty_amount" id="penaltyAmount" placeholder="0.00" value="0.00" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
      <p class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —à—Ç—Ä–∞—Ñ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
    </div>

    <div id="employeesSection">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞
        <span id="requiredStar" class="text-red-500 hidden">*</span>
      </label>
      <div class="border border-gray-300 rounded p-3 max-h-48 overflow-y-auto">
        {% for employee in employees %}
        <div class="flex items-center mb-2">
          <input type="checkbox" name="selected_employees" value="{{ employee.id }}" id="emp_{{ employee.id }}" class="employee-checkbox mr-2">
          <label for="emp_{{ employee.id }}" class="text-sm">{{ employee.name }} ({{ employee.role }})</label>
        </div>
        {% endfor %}
      </div>
      <p class="text-xs text-gray-500 mt-1">–®—Ç—Ä–∞—Ñ –±—É–¥–µ—Ç —Ä–∞–∑–¥–µ–ª—ë–Ω –ø–æ—Ä–æ–≤–Ω—É –º–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</p>
    </div>

    <div id="errorMessage" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-2 rounded">
      –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —à—Ç—Ä–∞—Ñ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    </div>

    <button type="submit" class="bg-red-600 text-white py-2 rounded hover:bg-red-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const penaltyInput = document.getElementById("penaltyAmount");
  const requiredStar = document.getElementById("requiredStar");
  const form = document.getElementById("returnForm");
  const errorMessage = document.getElementById("errorMessage");
  const returnDateInput = document.getElementById("returnDate");
  const orderSelect = document.getElementById("orderSelect");
  const phoneSearch = document.getElementById("phoneSearch");
  const orderSort = document.getElementById("orderSort");

  // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É –∫ –ø–æ–ª—é –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
  const phoneInputMask = new Inputmask("38099-999-99-99", {
    placeholder: "_",
    showMaskOnHover: false,
  });
  phoneInputMask.mask(phoneSearch);

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∏–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é)
  {% if selected_date %}
  const defaultDate = "{{ selected_date.isoformat() }}";
  {% else %}
  const defaultDate = new Date().toISOString().split('T')[0];
  {% endif %}
  returnDateInput.value = defaultDate;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤
  const allOrderOptions = Array.from(orderSelect.options).slice(1); // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –æ–ø—Ü–∏—é "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑"

  // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –º–∞—Å—Å–∏–≤–∞ –æ–ø—Ü–∏–π
  const sortOptions = (options, sortType) => {
    return options.sort((a, b) => {
      switch(sortType) {
        case 'date_desc':
          return b.dataset.orderDate.localeCompare(a.dataset.orderDate);
        case 'date_asc':
          return a.dataset.orderDate.localeCompare(b.dataset.orderDate);
        case 'amount_desc':
          return parseFloat(b.dataset.amount) - parseFloat(a.dataset.amount);
        case 'amount_asc':
          return parseFloat(a.dataset.amount) - parseFloat(b.dataset.amount);
        case 'created_desc':
          return (b.dataset.created || '').localeCompare(a.dataset.created || '');
        case 'created_asc':
          return (a.dataset.created || '').localeCompare(b.dataset.created || '');
        default:
          return 0;
      }
    });
  };

  // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä)
  const normalizePhone = (phone) => {
    return phone.replace(/\D/g, '');
  };

  // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
  const filterAndDisplayOrders = () => {
    const selectedDate = returnDateInput.value;
    const phoneQuery = normalizePhone(phoneSearch.value.toLowerCase().trim());
    const sortType = orderSort.value;

    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π ("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑")
    while (orderSelect.options.length > 1) {
      orderSelect.remove(1);
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–∫–∞–∑—ã
    let filteredOptions = allOrderOptions.filter(option => {
      // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
      if (selectedDate && option.dataset.orderDate !== selectedDate) {
        return false;
      }
      // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞)
      if (phoneQuery && !normalizePhone(option.dataset.phone.toLowerCase()).includes(phoneQuery)) {
        return false;
      }
      return true;
    });

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
    filteredOptions = sortOptions([...filteredOptions], sortType);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
    if (filteredOptions.length > 0) {
      filteredOptions.forEach(option => {
        orderSelect.appendChild(option.cloneNode(true));
      });
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      const noOrdersOption = document.createElement('option');
      noOrdersOption.value = '';
      noOrdersOption.textContent = '–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º';
      noOrdersOption.disabled = true;
      orderSelect.appendChild(noOrdersOption);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
  returnDateInput.addEventListener("change", filterAndDisplayOrders);
  phoneSearch.addEventListener("input", filterAndDisplayOrders);
  orderSort.addEventListener("change", filterAndDisplayOrders);

  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  filterAndDisplayOrders();
});
</script>
{% endblock %}
