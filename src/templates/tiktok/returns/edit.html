{% extends "base.html" %}
{% block title %}Редактировать возврат{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-xl font-semibold mb-4">Редактировать возврат #{{ ret.id | e }}</h2>
  <form method="post" class="flex flex-col gap-4" id="returnForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Дата возврата <span class="text-red-500">*</span></label>
      <input type="date" name="date_" value="{{ ret.date }}" required class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Сумма возврата (грн) <span class="text-red-500">*</span></label>
      <input type="number" step="0.01" name="amount" value="{{ ret.amount }}" required class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Причина</label>
      <textarea name="reason" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500">{{ ret.reason }}</textarea>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Связанный заказ (необязательно)</label>
      <select name="order_id" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500">
        <option value="">Не указан</option>
        {% for order in orders %}
        <option value="{{ order.id }}" {% if ret.order_id == order.id %}selected{% endif %}>
          Заказ #{{ order.id }} - {{ order.date }} - {{ order.phone_number }} - {{ order.amount }} грн ({{ order.created_by_user.name }})
        </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Сумма штрафа (грн)</label>
      <input type="number" step="0.01" name="penalty_amount" id="penaltyAmount" placeholder="0.00" value="{{ ret.penalty_amount }}" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500" />
      <p class="text-xs text-gray-500 mt-1">Если указан штраф, необходимо выбрать сотрудников</p>
    </div>

    <div id="employeesSection">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Сотрудники для назначения штрафа
        <span id="requiredStar" class="text-red-500 {% if ret.penalty_amount == 0 %}hidden{% endif %}">*</span>
      </label>
      <div class="border border-gray-300 rounded p-3 max-h-48 overflow-y-auto">
        {% for employee in employees %}
        <div class="flex items-center mb-2">
          <input type="checkbox" name="selected_employees" value="{{ employee.id }}" id="emp_{{ employee.id }}" class="employee-checkbox mr-2" {% if employee.id in penalized_employee_ids %}checked{% endif %}>
          <label for="emp_{{ employee.id }}" class="text-sm">{{ employee.name }} ({{ employee.role }})</label>
        </div>
        {% endfor %}
      </div>
      <p class="text-xs text-gray-500 mt-1">Штраф будет разделён поровну между выбранными сотрудниками</p>
    </div>

    <div id="errorMessage" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-2 rounded">
      Если указан штраф, необходимо выбрать хотя бы одного сотрудника
    </div>

    <button type="submit" class="bg-green-600 text-white py-2 rounded hover:bg-green-700">Сохранить</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const penaltyInput = document.getElementById("penaltyAmount");
  const requiredStar = document.getElementById("requiredStar");
  const form = document.getElementById("returnForm");
  const errorMessage = document.getElementById("errorMessage");

  // Показываем звёздочку "обязательно", если штраф > 0
  penaltyInput.addEventListener("input", () => {
    const penalty = parseFloat(penaltyInput.value) || 0;
    if (penalty > 0) {
      requiredStar.classList.remove("hidden");
    } else {
      requiredStar.classList.add("hidden");
    }
  });

  // Валидация формы
  form.addEventListener("submit", (e) => {
    const penalty = parseFloat(penaltyInput.value) || 0;
    const checkboxes = document.querySelectorAll('.employee-checkbox:checked');

    if (penalty > 0 && checkboxes.length === 0) {
      e.preventDefault();
      errorMessage.classList.remove("hidden");
      setTimeout(() => {
        errorMessage.classList.add("hidden");
      }, 5000);
    }
  });
});
</script>
{% endblock %}
