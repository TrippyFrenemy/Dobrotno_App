{% extends "base.html" %}
{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {{ order_type.name }}{% endblock %}

{% block content %}
<h2 class="text-2xl font-semibold mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {{ order_type.name | e }}</h2>

<!-- –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
  <form method="get" class="space-y-4">
    <div class="flex flex-wrap gap-4 items-end">
      <!-- –†–µ–∂–∏–º –ø–µ—Ä–∏–æ–¥–∞ -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">–†–µ–∂–∏–º</label>
        <select name="period_mode" id="period_mode" class="border p-2 rounded" onchange="togglePeriodInputs()">
          <option value="new" {% if period_mode == 'new' %}selected{% endif %}>–ù–µ–¥–µ–ª—å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã</option>
          <option value="custom" {% if period_mode == 'custom' %}selected{% endif %}>–°–≤–æ–π –ø–µ—Ä–∏–æ–¥</option>
        </select>
      </div>

      <!-- –ú–µ—Å—è—Ü/–ì–æ–¥ (–¥–ª—è –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤) -->
      <div id="monthly_inputs" class="flex gap-2">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–ú–µ—Å—è—Ü</label>
          <select name="month" class="border p-2 rounded">
            {% for m in range(1, 13) %}
              <option value="{{ m }}" {% if month == m %}selected{% endif %}>
                {{ ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'][m-1] }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–ì–æ–¥</label>
          <select name="year" class="border p-2 rounded">
            {% for y in range(2023, year + 1) %}
              <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- –°–≤–æ–π –ø–µ—Ä–∏–æ–¥ -->
      <div id="custom_inputs" class="flex gap-2" style="display: none;">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–°</label>
          <input type="date" name="custom_start" value="{{ custom_start if custom_start else '' }}" class="border p-2 rounded">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–ü–æ</label>
          <input type="date" name="custom_end" value="{{ custom_end if custom_end else '' }}" class="border p-2 rounded">
        </div>
      </div>

      <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      <a href="/order-types/" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
  </form>
</div>

<script>
function togglePeriodInputs() {
  const mode = document.getElementById('period_mode').value;
  const monthly = document.getElementById('monthly_inputs');
  const custom = document.getElementById('custom_inputs');

  if (mode === 'custom') {
    monthly.style.display = 'none';
    custom.style.display = 'flex';
  } else {
    monthly.style.display = 'flex';
    custom.style.display = 'none';
  }
}
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', togglePeriodInputs);
</script>

<!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–ø–µ -->
<div class="bg-blue-50 p-4 rounded border border-blue-200 mb-6">
  <div class="text-sm text-gray-600">–ö–æ–º–∏—Å—Å–∏—è —Ç–∏–ø–∞</div>
  <div class="text-2xl font-bold text-blue-700">{{ "%.0f"|format(order_type.commission_percent) }}%</div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º -->
{% for period in periods_data %}
<div class="bg-white rounded-lg shadow mb-6">
  <div class="bg-gray-100 px-4 py-3 border-b">
    <h3 class="text-lg font-semibold">
      üìÖ {{ period.title }} ({{ period.start_date.strftime('%d.%m') }} ‚Äì {{ period.end_date.strftime('%d.%m.%Y') }})
    </h3>
  </div>

  <div class="p-4">
    <!-- –ò—Ç–æ–≥–∏ –ø–µ—Ä–∏–æ–¥–∞ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div class="bg-green-50 p-3 rounded border border-green-200">
        <div class="text-sm text-gray-600">–ó–∞–∫–∞–∑–æ–≤</div>
        <div class="text-xl font-bold text-green-700">{{ period.total_count }}</div>
      </div>
      <div class="bg-purple-50 p-3 rounded border border-purple-200">
        <div class="text-sm text-gray-600">–°—É–º–º–∞</div>
        <div class="text-xl font-bold text-purple-700">{{ "%.2f"|format(period.total_amount) }} –≥—Ä–Ω</div>
      </div>
      <div class="bg-orange-50 p-3 rounded border border-orange-200">
        <div class="text-sm text-gray-600">–°—Ä–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑</div>
        <div class="text-xl font-bold text-orange-700">{{ "%.2f"|format(period.avg_amount) }} –≥—Ä–Ω</div>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º -->
    {% if period.daily_stats %}
    <details class="mt-2">
      <summary class="cursor-pointer text-blue-600 hover:underline">üìà –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ –¥–Ω—è–º ({{ period.daily_stats | length }})</summary>
      <table class="w-full text-sm border mt-2">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">–î–∞—Ç–∞</th>
            <th class="p-2 border">–ó–∞–∫–∞–∑–æ–≤</th>
            <th class="p-2 border">–°—É–º–º–∞</th>
          </tr>
        </thead>
        <tbody>
          {% for day in period.daily_stats %}
          <tr>
            <td class="p-2 border">{{ day.date.strftime('%d.%m.%Y') }}</td>
            <td class="p-2 border text-center">{{ day.count }}</td>
            <td class="p-2 border text-right">{{ "%.2f"|format(day.amount) }} –≥—Ä–Ω</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
    {% else %}
    <p class="text-gray-500 italic text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</p>
    {% endif %}
  </div>
</div>
{% endfor %}

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã -->
{% if recent_orders %}
<div class="bg-white rounded-lg shadow">
  <div class="bg-gray-100 px-4 py-3 border-b">
    <h3 class="text-lg font-semibold">üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–∫–∞–∑–æ–≤</h3>
  </div>
  <div class="p-4">
    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 border">‚Ññ</th>
          <th class="p-2 border">–î–∞—Ç–∞</th>
          <th class="p-2 border">–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th class="p-2 border">–°—É–º–º–∞</th>
        </tr>
      </thead>
      <tbody>
        {% for order in recent_orders %}
        <tr>
          <td class="p-2 border">{{ loop.index }}</td>
          <td class="p-2 border">{{ order.date.strftime('%d.%m.%Y') }}</td>
          <td class="p-2 border">{{ order.phone_number | e }}</td>
          <td class="p-2 border text-right">{{ order.amount | e }} –≥—Ä–Ω</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<p class="italic text-gray-600">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞.</p>
{% endif %}

{% endblock %}
