{% extends "base.html" %}
{% block title %}–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç{% endblock %}

{% block content %}
<h2 class="text-2xl font-semibold mb-4">üìä –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç –∑–∞ {{ month }}/{{ year }}</h2>

<!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –º–µ—Å—è—Ü–∞ -->
<form method="get" class="mb-6 flex gap-4 items-end">
  <div>
    <label class="block text-sm">–ú–µ—Å—è—Ü</label>
    <input type="number" name="month" value="{{ month }}" min="1" max="12" class="border p-2 rounded w-24">
  </div>
  <div>
    <label class="block text-sm">–ì–æ–¥</label>
    <input type="number" name="year" value="{{ year }}" class="border p-2 rounded w-32">
  </div>
  <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">–ü–æ–∫–∞–∑–∞—Ç—å</button>
</form>

<!-- –ë–ª–æ–∫ –æ—Ç—á—ë—Ç–∞ -->
{% for title, days, period in [("1‚Äì15", first_half, first_half_range), ("16‚Äì–∫–æ–Ω–µ—Ü", second_half, second_half_range)] %}
<h3 class="text-xl font-semibold mt-8 mb-2">üóì –ü–µ—Ä–∏–æ–¥: {{ period[0] }} ‚Äî {{ period[1] }} ({{ title }})</h3>

<table class="w-full text-sm border">
  <thead class="bg-gray-100">
    <tr>
      <th class="p-2 border">–î–∞—Ç–∞</th>
      <th class="p-2 border">–ö–∞—Å—Å–∞</th>
      <th class="p-2 border">–í–æ–∑–≤—Ä–∞—Ç—ã</th>
      <th class="p-2 border">–ò—Ç–æ–≥</th>
      <th class="p-2 border">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</th>
      <th class="p-2 border">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>    
    </tr>
  </thead>
  <tbody>
    {% set total_cash = 0 %}
    {% set total_returns = 0 %}
    {% for day in days %}
    <tr>
      <td class="p-2 border">{{ day.date }}</td>
      <td class="p-2 border">{{ "%.2f"|format(day.orders) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(day.returns) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(day.cashbox) }}</td>
      {% set total_cash = total_cash + day.orders %}
      {% set total_returns = total_returns + day.returns %}
      <td class="p-2 border">
        {% for uid in day.employees %}
          {{ user_map.get(uid, "‚Äî") }}<br>
        {% endfor %}
      </td>
      <td class="p-2 border">
        {% for uid in day.creators %}
          {{ user_map.get(uid, "‚Äî") }}<br>
        {% endfor %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot class="bg-gray-100 font-semibold">
    <tr>
      <td class="p-2 border text-right" colspan="1">–ò–¢–û–ì–û:</td>
      <td class="p-2 border">{{ "%.2f"|format(total_cash) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(total_returns) }}</td>
      <td class="p-2 border">{{ "%.2f"|format(total_cash - total_returns) }}</td>
    </tr>
  </tfoot>
</table>

<!-- –ë–ª–æ–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º -->
<h4 class="text-lg font-semibold mt-4">üë• –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º (—Å—Ç–∞–≤–∫–∞ + %)</h4>

<table class="w-full text-sm border mb-8">
  <thead class="bg-gray-50">
    <tr>
        <th class="p-2 border">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th class="p-2 border">–ü–æ —Å—Ç–∞–≤–∫–µ</th>
        <th class="p-2 border">–ü—Ä–æ—Ü–µ–Ω—Ç</th>
        <th class="p-2 border">–ò—Ç–æ–≥–æ</th>
        <th class="p-2 border">–í—ã–ø–ª–∞—á–µ–Ω–æ</th>
        <th class="p-2 border">–û—Å—Ç–∞–ª–æ—Å—å</th>
        <th class="p-2 border">–î–æ–ø–ª–∞—Ç–∏—Ç—å</th>
    </tr>
  </thead>
  <tbody>
    {% set user_totals = dict() %}
    {% for day in days %}
      {% for uid, amount in day.salary_by_user.items() %}
        {% if uid not in user_totals %}
          {% set _ = user_totals.update({uid: amount}) %}
        {% else %}
          {% set _ = user_totals.update({uid: user_totals[uid] + amount}) %}
        {% endif %}
      {% endfor %}
    {% endfor %}

    {% for uid in user_totals.keys() %}
    <tr>
    <td class="p-2 border">üë§ {{ user_map.get(uid, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") }}</td>

    {% set ns = namespace(fixed=0, percent=0) %}
    {% for day in days %}
        {% set ns.fixed = ns.fixed + day.salary_fixed_by_user.get(uid, 0) %}
        {% set ns.percent = ns.percent + day.salary_percent_by_user.get(uid, 0) %}
    {% endfor %}

    <td class="p-2 border">{{ "%.2f"|format(ns.fixed) }}</td>
    <td class="p-2 border">{{ "%.2f"|format(ns.percent) }}</td>
    <td class="p-2 border">{{ "%.2f"|format(ns.fixed + ns.percent) }}</td>

    {% set payouts = payouts_1_15 if title == "1‚Äì15" else payouts_16_31 %}
    {% set paid = payouts.get(uid, 0) %}
    <td class="p-2 border">{{ "%.2f"|format(paid) }}</td>
    <td class="p-2 border">{{ "%.2f"|format(ns.fixed + ns.percent - paid) }}</td>
    <td class="p-2 border">
        <form method="post" action="/reports/pay">
        <input type="hidden" name="user_id" value="{{ uid }}">
        <input type="hidden" name="date" value="{{ period[0] }}">
        <input type="number" step="0.01" name="amount" placeholder="0.00" class="border p-1 rounded w-24">
        <button class="text-green-600 hover:underline">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button>
        </form>
    </td>
    </tr>
    {% endfor %}

  </tbody>
</table>
{% endfor %}

{% endblock %}
